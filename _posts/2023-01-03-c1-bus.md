---
title: Transloc 
author: aaron
date: 2023-01-03 11:00:00 -0500
categories: [projects, engineering]
tags: [webscraping, apis, duke]
---

TL;DR:
: I built a device that displays the bus schedule for the bus that runs between the two halves of Duke's campus.

---

Duke is split into two halves, East Campus and West Campus. East houses the freshman undergraduate population and a few classes (mostly humanities) while the rest of the university is on West. There's a bus line called the C-1 that runs between the two campuses. Buses run anywhere from every few minutes at peak hours to roughly every 20 minutes late at night. 

Because the bus line is run by Duke, they've integrated this system called "Transloc" into their busing system. It's essentially a bus tracker--it allows you to see where all the buses are in real-time and it provides estimates as to when each bus will arrive at their stops. I know a few other universities also have Transloc, or something similar.

To its credit, Transloc is a fairly good product. There's a mobile app that doesn't have an ugly UI, and the information it displays is accurate. My main gripe with it is that the app can be slow at times. When I'm in my room on East Campus and I need to know exactly how long I have until the last bus I can take that will get me to class on time arrives, I can't be sitting around waiting a full 5 seconds until the app loads before taking a couple of seconds to navigate to the C-1 bus information. Too slow.

In NYC, every bus stop is equipped with a small screen that displays time estimates for the next few buses in real-time. I wanted one of those in my room. So, with the extra time I had at the end of the semester, I started work on building a small device that could display time estimates for the C-1 bus.

### Part One: Webscraping

#### Proof of Concept in Python
I've been familiar with the concept of webscraping before coming to Duke, but I've never tried webscraping myself. I thought that this would be a good first project for webscraping because Transloc also has a website, so I decided to give it a try. I figured that given its extensive packages, Python would be the easiest language to scrape with so I first used Python to ensure that webscraping was the right tool for this project. It didn't take long before I was able to retrieve the page HTML:

```py
import requests

URL = "https://duke.transloc.com/t/stops/4117202"
page = requests.get(URL)

print(page.text)
```

The information that was returned provided time estimates for the next two buses for the stop on East Campus, which was exactly what I was looking for. With that in mind, I started work on figuring out how I could webscrape on a microcontroller.

#### Webscraping on a Microcontroller
The two microcontrollers I had access to were the ESP-8266 and the ESP-32. The ESP-32 is the newer and more powerful of the two, so I went with that.

Here was the plan:
1. Connect to Duke's Wi-Fi network
2. Send a GET request to the Transloc website
3. Parse the HTML payload to extract the time estimates
4. Display the time estimates on a screen

I was mainly concerned with the first two steps, given that I had no experience with either of them. After a few hours of examining examples and tutorials, I was able to put together this code:

```cpp
#include <WiFi.h>
#include <WiFiClient.h>

#define WIFI_SSID "DukeVisitor"
#define WIFI_PASSWORD NULL

#define HOST_WEBSITE "https://duke.transloc.com/t/stops/4117202"

void setup() {
    Serial.begin(115200);

    // connect MCU to DukeVisitor Wi-Fi
    WiFi.mode(WIFI_STA);
    WiFi.begin(WIFI_SSID, WIFI_PASSWORD);

    // setup tcp connection 
    WiFiClient client;
    client.print(F("GET "));
    client.print("/");
    client.println(F(" HTTP/1.1"));

    // request specific website
    client.print(F("Host: "));
    client.println(HOST_WEBSITE);
    client.println(F("Cache-Control: no-cache"));
}
```

Theoretically, at the end of setup, `client` should have contained the HTML of the website. The plan was to then extract the time estimates by parsing the payload. However, the code threw `Error 302`, a redirection error.

Theoretically, this should've accomplished steps 1 and 2, but instead, I was met with a redirection error (`Error 302`). I had no clue what that really meant, given that I'm not familiar with the HTTP protocol. I tried to look up what the error meant, but I couldn't find anything other than the fact that the URL I was trying to access was moved.

I talked with my TA from my Introduction to Engineering (EGR 101) class, and he told me that the problem was that I was trying to access a website over HTTP, but the website was actually using HTTPS. With a bit of research, I found that I could simple line of code to fix the problem: `client.setInsecure();`. However, the ESP-32 Wi-Fi client doesn't support this function, so I switched to the ESP-8266 and included `WiFiClientSecure` instead of `WiFiClient`. This fixed the problem, and I was able to successfully retrieve the HTML payload.

#### Parsing the HTML
Now that I had the HTML payload, all I had to do was extract the time estimates. I employed the same strategy I used in my Python proof of concept by searching for the table element that had the class `wait_time time_1`. However, I quickly realized that the payload that I was receiving was different from the one I received in Python. In fact, the payload I received didn't even contain the bus information--the `wait_time` field was empty.

I'm still not exactly sure why this is true, but I hypothesize that because the website was using JavaScript to dynamically generate the HTML, the HTML I was receiving was not the same HTML that was being displayed on the website. This hypothesis doesn't make much sense to me, given that I was able to retrieve the HTML payload in Python, but I'm not sure what else could be causing the problem.

I decided to look for a different way to retrieve the bus information.

### Part Two: Transloc API
From the start of the project, I knew that using an API was probably the best idea for this project for a few reasons:
1. Parsing a massive HTML payload would be both slow and annoying to code
2. The payload returned by an API would be significantly smaller, which is important given that the microcontrollers I'm using have limited memory
3. I wouldn't have to worry about the website changing its HTML structure if the website were to update

I looked at the Transloc API documentation and realized that I would need to request access to the API from Duke. 